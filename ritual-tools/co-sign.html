<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Sign - Lightweight Decision Commitment</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0B2A2F 0%, #0D3B2A 100%);
            min-height: 100vh;
            padding: 20px;
            color: #3D3D3D;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #FFF5E1;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #2B7A78;
        }

        .header h1 {
            font-size: 48px;
            color: #0B2A2F;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .tagline {
            font-size: 18px;
            color: #718096;
            font-weight: 400;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #0B2A2F;
            margin-bottom: 8px;
            font-size: 16px;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            background: white;
            color: #3D3D3D;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #DAA520;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .hint {
            font-size: 14px;
            color: #718096;
            margin-top: 6px;
            font-style: italic;
        }

        .btn {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: #DAA520;
            color: #0B2A2F;
        }

        .btn-primary:hover {
            background: #B8860B;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #FFF5E1;
            color: #0B2A2F;
            border: 2px solid #2B7A78;
        }

        .btn-secondary:hover {
            background: #F5E6C8;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .suggestions {
            background: #F0F9F8;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }

        .suggestions-label {
            font-size: 14px;
            color: #0B2A2F;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .suggestions-text {
            font-size: 14px;
            color: #5B7553;
        }

        .line-item {
            background: white;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .line-item input {
            border: 1px solid #E2E8F0;
            margin-bottom: 8px;
        }

        .line-item .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #E97451;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .line-item .remove-btn:hover {
            background: #D65A3A;
        }

        .add-more-btn {
            width: 100%;
            padding: 12px;
            background: #F0F9F8;
            border: 2px dashed #2B7A78;
            border-radius: 6px;
            color: #0B2A2F;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .add-more-btn:hover {
            background: #E0F2F1;
        }

        .teammate-item {
            background: white;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            gap: 12px;
            align-items: start;
        }

        .teammate-item .icon-select {
            font-size: 32px;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            background: white;
        }

        .session-created {
            text-align: center;
        }

        .session-code-display {
            background: white;
            border: 3px solid #DAA520;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
        }

        .session-code-display .code {
            font-size: 32px;
            font-weight: 700;
            color: #0B2A2F;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            margin: 12px 0;
        }

        .session-link {
            background: #F0F9F8;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            word-break: break-all;
            font-size: 14px;
            color: #0B2A2F;
        }

        .copy-btn {
            background: #2B7A78;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 6px;
        }

        .copy-btn:hover {
            background: #236663;
        }

        .icon-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .icon-picker-modal.active {
            display: flex;
        }

        .icon-picker-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .icon-option {
            font-size: 32px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            border: 2px solid transparent;
        }

        .icon-option:hover {
            background: #F0F9F8;
            border-color: #2B7A78;
        }

        .footer {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px solid #2B7A78;
            text-align: center;
            color: #718096;
            font-size: 14px;
        }

        .footer strong {
            color: #0B2A2F;
        }

        .footer a {
            color: #2B7A78;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer ul {
            list-style: none;
            margin: 12px 0;
        }

        .footer li {
            margin: 6px 0;
        }

        /* Review Screen Styles */
        .line-review-item {
            background: white;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .line-review-item h4 {
            color: #0B2A2F;
            margin: 0 0 16px 0;
            font-size: 16px;
        }

        .response-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .response-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            background: white;
            color: #3D3D3D;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .response-btn:hover {
            border-color: #2B7A78;
            background: #F0F9F8;
        }

        .response-btn.selected {
            border-color: #2B7A78;
            background: #2B7A78;
            color: white;
        }

        .response-btn.commit-btn.selected {
            background: #5B7553;
            border-color: #5B7553;
        }

        .response-btn.needinfo-btn.selected {
            background: #2B7A78;
            border-color: #2B7A78;
        }

        .response-btn.cantcommit-btn.selected {
            background: #E97451;
            border-color: #E97451;
        }

        .response-detail {
            display: none;
            background: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            padding: 16px;
            margin-top: 12px;
        }

        .response-detail.active {
            display: block;
        }

        .response-detail textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .response-detail input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            font-size: 14px;
        }

        .response-detail label {
            display: block;
            color: #3D3D3D;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .response-detail .helper-text {
            color: #718096;
            font-size: 13px;
            margin-top: 6px;
        }

        .responders-list {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .responder-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F0F9F8;
            border: 2px solid #2B7A78;
            border-radius: 50%;
            font-size: 16px;
        }

        .required-field {
            color: #E97451;
            font-size: 13px;
            margin-top: 4px;
        }

        /* Dashboard Styles */
        .dashboard-line-item {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .dashboard-line-item.complete {
            border-color: #5B7553;
            background: #F7FCFA;
        }

        .dashboard-line-item.needs-attention {
            border-color: #E97451;
            background: #FEF7F5;
        }

        .dashboard-line-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
            gap: 16px;
        }

        .dashboard-line-header h4 {
            margin: 0;
            color: #0B2A2F;
            font-size: 16px;
            flex: 1;
        }

        .response-status {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .response-status.complete {
            color: #5B7553;
        }

        .response-status.partial {
            color: #D97706;
        }

        .response-status.none {
            color: #718096;
        }

        .dashboard-responses {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .dashboard-response-item {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #E2E8F0;
        }

        .dashboard-response-item.commit {
            border-left-color: #5B7553;
        }

        .dashboard-response-item.needInfo {
            border-left-color: #2B7A78;
        }

        .dashboard-response-item.cantCommit {
            border-left-color: #E97451;
        }

        .dashboard-response-icon {
            font-size: 20px;
            min-width: 24px;
        }

        .dashboard-response-content {
            flex: 1;
        }

        .dashboard-response-content .name {
            font-weight: 600;
            color: #0B2A2F;
            margin-bottom: 4px;
        }

        .dashboard-response-content .note {
            color: #3D3D3D;
            font-size: 14px;
            margin-top: 4px;
        }

        .dashboard-response-content .question {
            color: #0B2A2F;
            font-size: 14px;
            font-style: italic;
            margin-top: 4px;
        }

        .dashboard-response-content .blocker {
            color: #D97706;
            font-size: 14px;
            font-weight: 500;
            margin-top: 4px;
        }

        .dashboard-teammate-item {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .dashboard-teammate-item.complete {
            border-color: #5B7553;
        }

        .dashboard-teammate-item.partial {
            border-color: #D97706;
        }

        .dashboard-teammate-icon {
            font-size: 32px;
            min-width: 40px;
            text-align: center;
        }

        .dashboard-teammate-info {
            flex: 1;
        }

        .dashboard-teammate-info .name {
            font-weight: 700;
            color: #0B2A2F;
            margin-bottom: 4px;
        }

        .dashboard-teammate-info .role {
            color: #718096;
            font-size: 14px;
        }

        .dashboard-teammate-progress {
            text-align: right;
        }

        .dashboard-teammate-progress .percentage {
            font-size: 24px;
            font-weight: 700;
            color: #0B2A2F;
        }

        .dashboard-teammate-progress .label {
            font-size: 13px;
            color: #718096;
        }

        @media (max-width: 600px) {
            .container {
                padding: 24px;
            }

            .header h1 {
                font-size: 36px;
            }

            .teammate-item {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .response-buttons {
                flex-direction: column;
            }

            .response-btn {
                min-width: 100%;
            }

            .dashboard-line-header {
                flex-direction: column;
                gap: 8px;
            }

            .dashboard-teammate-item {
                flex-direction: column;
                text-align: center;
            }

            .dashboard-teammate-progress {
                text-align: center;
            }

            .icon-picker-content {
                max-width: 90vw;
                padding: 24px;
            }

            .export-preview {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Co-Sign</h1>
            <p class="tagline">Lightweight commitment for team decisions</p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <p style="text-align: center; font-size: 18px; color: #718096; margin-bottom: 30px;">
                Get clear sign-off line-by-line, with friendly accountability that actually sticks.
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showScreen('setupScreen')">Create New Session</button>
                <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Join Existing Session</button>
            </div>
        </div>

        <!-- Setup Session Screen -->
        <div id="setupScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Create Session</h2>
            
            <div class="form-group">
                <label>Decision name: *</label>
                <input type="text" id="sessionName" placeholder="e.g., Q1 Product Roadmap" required>
            </div>

            <div class="form-group">
                <label>Context (optional - link or description):</label>
                <textarea id="sessionContext" placeholder="Add a link to your doc or brief description..."></textarea>
            </div>

            <div class="form-group">
                <label>Deadline (optional):</label>
                <input type="date" id="sessionDeadline">
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')">Back</button>
                <button class="btn btn-primary" onclick="showScreen('customizeButtonsScreen')">Continue</button>
            </div>
        </div>

        <!-- Customize Buttons Screen -->
        <div id="customizeButtonsScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Customize Experience</h2>
            
            <div class="form-group">
                <label>When teammates commit, button says: *</label>
                <input type="text" id="commitButtonText" placeholder="I'm in" maxlength="20" required>
                <div class="suggestions">
                    <div class="suggestions-label">üí° Examples:</div>
                    <div class="suggestions-text">I'm in | I agree | Count me in | I commit to this | Let's do it</div>
                </div>
            </div>

            <div class="form-group">
                <label>When teammates need info:</label>
                <select id="needInfoButton">
                    <option value="Need More Info">Need More Info</option>
                    <option value="Open Questions">Open Questions</option>
                    <option value="Let's Discuss">Let's Discuss</option>
                    <option value="Need Clarification">Need Clarification</option>
                    <option value="Want to Talk">Want to Talk</option>
                </select>
            </div>

            <div class="form-group">
                <label>When they can't commit:</label>
                <select id="cantCommitButton">
                    <option value="Can't Commit">Can't Commit</option>
                    <option value="Have Concerns">Have Concerns</option>
                    <option value="Need Changes">Need Changes</option>
                    <option value="Data Request">Data Request</option>
                    <option value="Can't Right Now">Can't Right Now</option>
                    <option value="Need Discussion">Need Discussion</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('setupScreen')">Back</button>
                <button class="btn btn-primary" onclick="showScreen('addLinesScreen')">Continue</button>
            </div>
        </div>

        <!-- Add Lines Screen -->
        <div id="addLinesScreen" class="screen">
            <h2 style="margin-bottom: 16px; color: #0B2A2F;">Commitments to Sign</h2>
            <p style="color: #718096; margin-bottom: 24px; line-height: 1.5;">
                Create a line for each decision you're seeking agreement on. Your teammates will respond to each line individually‚Äîso you'll know exactly what people commit to and where they have questions.
            </p>
            
            <div id="linesContainer">
                <!-- Lines will be added dynamically -->
            </div>

            <button class="add-more-btn" onclick="addLine()">+ Add Another Line</button>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('customizeButtonsScreen')">Back</button>
                <button class="btn btn-primary" onclick="showScreen('addTeammatesScreen')">Continue to Add Teammates</button>
            </div>
        </div>

        <!-- Add Teammates Screen -->
        <div id="addTeammatesScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Add Teammates</h2>
            
            <div id="teammatesContainer">
                <!-- Teammates will be added dynamically -->
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <button class="add-more-btn" onclick="addTeammate()" style="width: 50%;">+ Add Teammate</button>
                <button id="importContextCardBtn" class="add-more-btn" onclick="showImportModal()" style="width: 50%; background: #2B7A78; color: white; border: 2px solid #2B7A78;">üé¥ Import from Context Card</button>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('addLinesScreen')">Back</button>
                <button class="btn btn-primary" onclick="createSession()">Create Session</button>
            </div>
        </div>

        <!-- Session Created Screen -->
        <div id="sessionCreatedScreen" class="screen">
            <div class="session-created">
                <h2 style="color: #0B2A2F; margin-bottom: 16px;">‚úÖ Session Created!</h2>
                
                <div id="sessionSummary">
                    <!-- Will be populated dynamically -->
                </div>

                <div class="session-code-display">
                    <div style="font-size: 16px; color: #718096; margin-bottom: 8px;">Session Code:</div>
                    <div class="code" id="displaySessionCode">COSIGN-XXXX</div>
                </div>

                <div>
                    <div style="font-size: 14px; color: #718096; margin-bottom: 8px;">Share link:</div>
                    <div class="session-link" id="displaySessionLink"></div>
                </div>

                <div style="margin: 24px 0;">
                    <button class="copy-btn" onclick="copyCode()">Copy Code</button>
                    <button class="copy-btn" onclick="copyLink()">Copy Link</button>
                </div>

                <button class="btn btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
            </div>
        </div>

        <!-- Join Session Screen -->
        <div id="joinScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Join Session</h2>
            
            <div class="form-group">
                <label>Enter session code:</label>
                <input type="text" id="joinCode" placeholder="COSIGN-XXXX" style="text-transform: uppercase;">
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')">Back</button>
                <button class="btn btn-primary" onclick="joinSession()">Join Session</button>
            </div>
        </div>

        <!-- Join Details Screen (icon picker + name/role) -->
        <div id="joinDetailsScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Join Session</h2>
            
            <div id="sessionInfoBox" style="background: #F0F9F8; border: 2px solid #2B7A78; border-radius: 6px; padding: 16px; margin-bottom: 24px;">
                <p style="color: #0B2A2F; margin: 0;"><strong id="sessionNameDisplay"></strong></p>
                <p style="color: #718096; margin: 8px 0 0 0; font-size: 14px;" id="sessionDetailsDisplay"></p>
                <div id="joinContextDisplay" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #2B7A78; display: none;">
                    <p style="color: #0B2A2F; margin: 0 0 4px 0; font-size: 13px; font-weight: 600;">Context:</p>
                    <p style="color: #3D3D3D; margin: 0; font-size: 13px; word-break: break-word;" id="joinContextText"></p>
                </div>
            </div>

            <div class="form-group">
                <label>Choose your icon:</label>
                <button type="button" class="icon-select" id="joinIconButton" onclick="openJoinIconPicker()">
                    <span class="selected-icon" id="joinSelectedIcon">?</span>
                </button>
                <p class="helper-text">Pick an emoji that represents you</p>
            </div>

            <div class="form-group">
                <label>Your name: <span class="required">*</span></label>
                <input type="text" id="joinName" placeholder="e.g., Alex">
            </div>

            <div class="form-group">
                <label>Your role (optional):</label>
                <input type="text" id="joinRole" placeholder="e.g., Engineering, Product, Design">
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Back</button>
                <button class="btn btn-primary" onclick="confirmJoin()">Continue to Review</button>
            </div>
        </div>

        <!-- Review Screen (respond to all lines) -->
        <div id="reviewScreen" class="screen">
            <h2 style="margin-bottom: 8px; color: #0B2A2F;">Review & Respond</h2>
            <p style="color: #718096; margin-bottom: 24px;" id="reviewSessionName"></p>
            
            <div id="linesReviewContainer"></div>

            <div class="btn-group" style="margin-top: 32px;">
                <button class="btn btn-secondary" onclick="showScreen('joinDetailsScreen')">Back</button>
                <button class="btn btn-primary" onclick="submitAllResponses()">Submit My Responses</button>
            </div>
        </div>

        <!-- Confirmation Screen (after submitting) -->
        <div id="confirmationScreen" class="screen">
            <div style="text-align: center; padding: 40px 0;">
                <div style="font-size: 64px; margin-bottom: 16px;">‚úì</div>
                <h2 style="color: #0B2A2F; margin-bottom: 16px;">Responses Submitted!</h2>
                <p style="color: #718096; margin-bottom: 32px;">Your responses have been recorded. The facilitator can now see your commitments.</p>
                
                <div id="confirmationSummary" style="background: #F0F9F8; border: 2px solid #2B7A78; border-radius: 6px; padding: 24px; margin-bottom: 24px; text-align: left;"></div>

                <button class="btn btn-primary" onclick="showScreen('welcomeScreen')">Done</button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h2 style="margin: 0 0 8px 0; color: #0B2A2F;" id="dashboardSessionName"></h2>
                    <p style="color: #718096; margin: 0;" id="dashboardSessionInfo"></p>
                    <div id="dashboardContext" style="margin-top: 12px; padding: 12px; background: #F0F9F8; border-left: 3px solid #2B7A78; border-radius: 4px; display: none;">
                        <p style="margin: 0; font-size: 14px; color: #0B2A2F; font-weight: 600;">Context:</p>
                        <p style="margin: 4px 0 0 0; font-size: 14px; color: #3D3D3D; word-break: break-word;" id="dashboardContextText"></p>
                    </div>
                </div>
                <div>
                    <p style="margin: 0; font-size: 14px; color: #718096;">Session Code:</p>
                    <p style="margin: 4px 0 0 0; font-size: 20px; font-weight: 700; color: #0B2A2F;" id="dashboardSessionCode"></p>
                </div>
            </div>

            <div id="dashboardProgressBar" style="background: #E2E8F0; border-radius: 8px; height: 12px; margin-bottom: 32px; overflow: hidden;">
                <div id="dashboardProgressFill" style="background: linear-gradient(90deg, #2B7A78 0%, #5B7553 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>

            <h3 style="color: #0B2A2F; margin-bottom: 16px; font-size: 18px;">Line Status</h3>
            <div id="dashboardLinesContainer"></div>

            <h3 style="color: #0B2A2F; margin-bottom: 16px; margin-top: 32px; font-size: 18px;">Teammate Status</h3>
            <div id="dashboardTeammatesContainer"></div>

            <div class="btn-group" style="margin-top: 32px;">
                <button class="btn btn-secondary" onclick="showScreen('sessionCreatedScreen')">Back to Session Details</button>
                <button class="btn btn-primary" onclick="exportSession()">Export Summary</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>Part of the Team Ritual Apps collection</strong></p>
            <p><a href="https://maurakrandall.github.io/">View all tools ‚Üí</a></p>
            
            <p style="margin-top: 20px;"><strong>Built using the "Triad" model:</strong></p>
            <ul>
                <li>üë§ <strong>Maura:</strong> Product vision, UX design</li>
                <li>ü§ñ¬è <strong>CP:</strong> Technical structure, system logic</li>
                <li>üîÆ <strong>Soph:</strong> Content drafting, strategic thinking</li>
            </ul>
            
            <p>Learn more at <a href="https://thehumanailoop.com/">The Human AI Loop</a></p>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div id="iconPickerModal" class="icon-picker-modal">
        <div class="icon-picker-content">
            <h3 style="margin-bottom: 16px; color: #0B2A2F;">Choose Your Icon</h3>
            <div class="icon-grid" id="iconGrid"></div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" onclick="closeIconPicker()">Close</button>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="icon-picker-modal">
        <div class="icon-picker-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 16px; color: #0B2A2F;">Export Session Summary</h3>
            
            <div style="background: #F7FAFC; border: 1px solid #E2E8F0; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                <pre id="exportPreview" style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; margin: 0; color: #3D3D3D; overflow-x: auto;"></pre>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeExportModal()">Close</button>
                <button class="btn btn-primary" onclick="copyExportToClipboard()">Copy to Clipboard</button>
                <button class="btn btn-primary" onclick="downloadExport()">Download .md</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables and functions need to be available to inline onclick handlers
        let database;
        let currentScreen = 'welcomeScreen';
        let lineCounter = 0;
        let teammateCounter = 0;
        let currentTeammateIndex = null;
        let sessionData = {
            lines: [],
            teammates: []
        };

        // Available Icons
        const availableIcons = ['üë§', '‚ù°', 'üéØ', 'üëÄ', '‚ú®', 'üî•', 'üí°', 'üåü', 'üíº', 'üé®', 'üìä', 'üîß', 'üí™', 'üé≠', 'üåà', '‚≠ï¬ê', 'üé™', 'üé¨', 'üì±', 'üíª', 'üéÆ', 'üéµ', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'ü•Å', 'üé§', 'üéß', 'üìª', 'üì∫', 'üì∑', 'üì∏', 'üé•'];

        // Initialize Firebase when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase is loaded
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded. Please ensure you are accessing this page via HTTPS.');
                alert('Firebase SDK not loaded. This app requires HTTPS to function properly.');
                return;
            }
            
            // Firebase Configuration - decision-alignment-tool project
            const firebaseConfig = {
                apiKey: "AIzaSyDTEDAjvGZH4-MOlo-xcDBRqcRQRioV-b4",
                authDomain: "decision-alignment-tool.firebaseapp.com",
                databaseURL: "https://decision-alignment-tool-default-rtdb.firebaseio.com",
                projectId: "decision-alignment-tool",
                storageBucket: "decision-alignment-tool.firebasestorage.app",
                messagingSenderId: "911538633564",
                appId: "1:911538633564:web:17808f5cf9aa178eb51f99"
            };

            // Initialize Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Firebase failed to initialize: ' + error.message);
            }

            // Initialize: Add first line and first teammate
            addLine();
            addTeammate();
            
            // Check if URL has session parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sessionCode = urlParams.get('session');
            if (sessionCode) {
                document.getElementById('joinCode').value = sessionCode;
                showScreen('joinScreen');
            }
        });

        // Screen Navigation - MUST be global for onclick handlers
        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
        }

        // Session Code Generation (from AlignFirst pattern) - GLOBAL
        window.generateSessionCode = function() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'COSIGN-';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Check if session code exists - GLOBAL
        window.isCodeUnique = async function(code) {
            const snapshot = await database.ref('sessions').orderByChild('code').equalTo(code).once('value');
            return !snapshot.exists();
        }

        // Generate unique session code - GLOBAL
        window.generateUniqueSessionCode = async function() {
            let code = generateSessionCode();
            let attempts = 0;
            while (!(await isCodeUnique(code)) && attempts < 10) {
                code = generateSessionCode();
                attempts++;
            }
            return code;
        }

        // Add Line - GLOBAL
        window.addLine = function() {
            lineCounter++;
            const container = document.getElementById('linesContainer');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-item';
            lineDiv.id = `line-${lineCounter}`;
            lineDiv.innerHTML = `
                <button class="remove-btn" onclick="removeLine(${lineCounter})">Remove</button>
                <label>Line ${lineCounter}:</label>
                <input type="text" id="lineText-${lineCounter}" placeholder="e.g., Q1 Goal: Launch Dashboard v2 by March 15" required>
            `;
            container.appendChild(lineDiv);
        }

        // Remove Line - GLOBAL
        window.removeLine = function(id) {
            const lineDiv = document.getElementById(`line-${id}`);
            if (lineDiv) {
                lineDiv.remove();
            }
        }

        // Add Teammate - GLOBAL
        window.addTeammate = function() {
            teammateCounter++;
            const container = document.getElementById('teammatesContainer');
            const teammateDiv = document.createElement('div');
            teammateDiv.className = 'teammate-item';
            teammateDiv.id = `teammate-${teammateCounter}`;
            teammateDiv.innerHTML = `
                <div class="icon-select" id="teammateIcon-${teammateCounter}" onclick="openIconPicker(${teammateCounter})">
                    üë§
                </div>
                <div>
                    <label>Name:</label>
                    <input type="text" id="teammateName-${teammateCounter}" placeholder="Name" required>
                </div>
                <div>
                    <label>Role (optional):</label>
                    <input type="text" id="teammateRole-${teammateCounter}" placeholder="Role">
                </div>
            `;
            container.appendChild(teammateDiv);
        }

        // Icon Picker - GLOBAL
        window.openIconPicker = function(index) {
            currentTeammateIndex = index;
            const modal = document.getElementById('iconPickerModal');
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = '';
            
            availableIcons.forEach(icon => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'icon-option';
                iconDiv.textContent = icon;
                iconDiv.onclick = () => selectIcon(icon);
                grid.appendChild(iconDiv);
            });
            
            modal.classList.add('active');
        }

        window.selectIcon = function(icon) {
            if (currentTeammateIndex === 'join') {
                // Join flow - set icon for joining teammate
                document.getElementById('joinSelectedIcon').textContent = icon;
            } else if (currentTeammateIndex !== null) {
                // Create flow - set icon for teammate being added
                document.getElementById(`teammateIcon-${currentTeammateIndex}`).textContent = icon;
            }
            closeIconPicker();
        }

        window.closeIconPicker = function() {
            document.getElementById('iconPickerModal').classList.remove('active');
            currentTeammateIndex = null;
        }

        // Create Session - GLOBAL
        window.createSession = async function() {
            try {
                // Validate inputs
                const sessionName = document.getElementById('sessionName').value.trim();
                if (!sessionName) {
                    alert('Please enter a decision name');
                    showScreen('setupScreen');
                    return;
                }

                const commitButtonText = document.getElementById('commitButtonText').value.trim() || "I'm in";
                if (commitButtonText.length < 2 || commitButtonText.length > 20) {
                    alert('Commit button text must be 2-20 characters');
                    showScreen('customizeButtonsScreen');
                    return;
                }

                // Collect lines
                const lines = {};
                let lineOrder = 1;
                const lineElements = document.querySelectorAll('[id^="lineText-"]');
                
                lineElements.forEach((element) => {
                    const lineText = element.value.trim();
                    if (lineText) {
                        const lineId = `line-${Date.now()}-${lineOrder}`;
                        lines[lineId] = {
                            text: lineText,
                            order: lineOrder++,
                            requiredSigners: "all",
                            responses: {}
                        };
                    }
                });

                if (Object.keys(lines).length === 0) {
                    alert('Please add at least one commitment line');
                    showScreen('addLinesScreen');
                    return;
                }

                // Collect teammates
                const teammates = {};
                const teammateNameElements = document.querySelectorAll('[id^="teammateName-"]');
                
                teammateNameElements.forEach((element, index) => {
                    const name = element.value.trim();
                    if (name) {
                        const id = element.id.split('-')[1];
                        const icon = document.getElementById(`teammateIcon-${id}`)?.textContent || 'üë§';
                        const role = document.getElementById(`teammateRole-${id}`)?.value.trim() || '';
                        
                        const userId = `user-${Date.now()}-${index}`;
                        teammates[userId] = {
                            name: name,
                            icon: icon,
                            role: role,
                            joinedAt: Date.now()
                        };
                    }
                });

                if (Object.keys(teammates).length === 0) {
                    alert('Please add at least one teammate');
                    showScreen('addTeammatesScreen');
                    return;
                }

                // Generate unique session code
                const sessionCode = await generateUniqueSessionCode();
                const sessionId = database.ref('sessions').push().key;

                // Get other form data
                const context = document.getElementById('sessionContext').value.trim();
                const deadline = document.getElementById('sessionDeadline').value;
                const needInfoButton = document.getElementById('needInfoButton').value;
                const cantCommitButton = document.getElementById('cantCommitButton').value;

                // Build session object
                const session = {
                    code: sessionCode,
                    name: sessionName,
                    context: context,
                    createdBy: Object.values(teammates)[0]?.name || "Facilitator",
                    createdAt: Date.now(),
                    deadline: deadline ? new Date(deadline).getTime() : null,
                    status: "open",
                    buttonLabels: {
                        commit: commitButtonText,
                        needInfo: needInfoButton,
                        cantCommit: cantCommitButton
                    },
                    lines: lines,
                    teammates: teammates
                };

                // Save to Firebase
                await database.ref(`sessions/${sessionId}`).set(session);
                
                // Store session ID for dashboard
                sessionStorage.setItem('currentSessionId', sessionId);
                sessionStorage.setItem('currentSessionCode', sessionCode);
                
                // Display session created screen
                displaySessionCreated(sessionCode, sessionName, Object.keys(lines).length, Object.keys(teammates).length);
                
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Error creating session: ' + error.message);
            }
        }

        // Display Session Created - GLOBAL
        window.displaySessionCreated = function(code, name, lineCount, teammateCount) {
            document.getElementById('displaySessionCode').textContent = code;
            
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?session=${code}`;
            document.getElementById('displaySessionLink').textContent = link;
            
            document.getElementById('sessionSummary').innerHTML = `
                <h3 style="color: #0B2A2F; margin-bottom: 8px;">${name}</h3>
                <p style="color: #718096;">${lineCount} commitments | ${teammateCount} teammates</p>
            `;
            
            showScreen('sessionCreatedScreen');
        }

        // Copy Functions - GLOBAL
        window.copyCode = function() {
            const code = document.getElementById('displaySessionCode').textContent;
            navigator.clipboard.writeText(code);
            alert('Session code copied!');
        }

        window.copyLink = function() {
            const link = document.getElementById('displaySessionLink').textContent;
            navigator.clipboard.writeText(link);
            alert('Link copied!');
        }

        // Go to Dashboard - GLOBAL
        window.goToDashboard = function() {
            showScreen('dashboardScreen');
        }

        // Join Session - GLOBAL
        window.joinSession = async function() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!code) {
                alert('Please enter a session code');
                return;
            }

            try {
                const snapshot = await database.ref('sessions').orderByChild('code').equalTo(code).once('value');
                if (snapshot.exists()) {
                    const sessionId = Object.keys(snapshot.val())[0];
                    const session = snapshot.val()[sessionId];
                    
                    // Store session info
                    sessionStorage.setItem('currentSessionId', sessionId);
                    sessionStorage.setItem('currentSessionCode', code);
                    sessionStorage.setItem('currentSession', JSON.stringify(session));
                    
                    // Display session info on join details screen
                    document.getElementById('sessionNameDisplay').textContent = session.name;
                    const lineCount = Object.keys(session.lines || {}).length;
                    const teammateCount = Object.keys(session.teammates || {}).length;
                    document.getElementById('sessionDetailsDisplay').textContent = 
                        `${lineCount} commitment${lineCount !== 1 ? 's' : ''} | ${teammateCount} teammate${teammateCount !== 1 ? 's' : ''} already joined`;
                    
                    // Display context if provided
                    const joinContextDiv = document.getElementById('joinContextDisplay');
                    const joinContextText = document.getElementById('joinContextText');
                    if (session.context && session.context.trim()) {
                        joinContextText.textContent = session.context;
                        joinContextDiv.style.display = 'block';
                    } else {
                        joinContextDiv.style.display = 'none';
                    }
                    
                    // Reset join form
                    document.getElementById('joinSelectedIcon').textContent = '?';
                    document.getElementById('joinName').value = '';
                    document.getElementById('joinRole').value = '';
                    
                    showScreen('joinDetailsScreen');
                } else {
                    alert('Session not found. Please check the code and try again.');
                }
            } catch (error) {
                console.error('Error joining session:', error);
                alert('Error joining session. Please try again.');
            }
        }

        // Open icon picker for join flow - GLOBAL
        window.openJoinIconPicker = function() {
            openIconPicker('join');  // Pass 'join' as the index for join flow
        }

        // Confirm join (save teammate to Firebase) - GLOBAL
        window.confirmJoin = async function() {
            const icon = document.getElementById('joinSelectedIcon').textContent;
            const name = document.getElementById('joinName').value.trim();
            const role = document.getElementById('joinRole').value.trim();
            
            if (icon === '?') {
                alert('Please choose an icon');
                return;
            }
            if (!name) {
                alert('Please enter your name');
                return;
            }

            try {
                const sessionId = sessionStorage.getItem('currentSessionId');
                const session = JSON.parse(sessionStorage.getItem('currentSession'));
                
                // Generate unique teammate ID
                const teammateId = `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // Create teammate object
                const teammate = {
                    name: name,
                    icon: icon,
                    role: role || null,
                    joinedAt: Date.now()
                };
                
                // Save teammate to Firebase
                await database.ref(`sessions/${sessionId}/teammates/${teammateId}`).set(teammate);
                
                // Store teammate ID for response submission
                sessionStorage.setItem('currentTeammateId', teammateId);
                sessionStorage.setItem('currentTeammateName', name);
                sessionStorage.setItem('currentTeammateIcon', icon);
                
                // Load review screen
                loadReviewScreen(session);
                
            } catch (error) {
                console.error('Error saving teammate:', error);
                alert('Error joining session. Please try again.');
            }
        }

        // Load review screen with all lines - GLOBAL
        window.loadReviewScreen = function(session) {
            document.getElementById('reviewSessionName').textContent = session.name;
            
            const container = document.getElementById('linesReviewContainer');
            container.innerHTML = '';
            
            const lines = session.lines || {};
            const lineIds = Object.keys(lines).sort((a, b) => lines[a].order - lines[b].order);
            
            lineIds.forEach((lineId, index) => {
                const line = lines[lineId];
                const lineDiv = document.createElement('div');
                lineDiv.className = 'line-review-item';
                lineDiv.setAttribute('data-line-id', lineId);
                
                lineDiv.innerHTML = `
                    <h4>${line.text}</h4>
                    
                    <div class="response-buttons">
                        <button class="response-btn commit-btn" onclick="selectResponse('${lineId}', 'commit')">
                            ${session.buttonLabels.commit}
                        </button>
                        <button class="response-btn needinfo-btn" onclick="selectResponse('${lineId}', 'needInfo')">
                            ${session.buttonLabels.needInfo} √¢‚Äì¬æ
                        </button>
                        <button class="response-btn cantcommit-btn" onclick="selectResponse('${lineId}', 'cantCommit')">
                            ${session.buttonLabels.cantCommit} √¢‚Äì¬æ
                        </button>
                    </div>
                    
                    <!-- Commit response detail -->
                    <div class="response-detail" id="commit-${lineId}">
                        <label>Add a note (optional):</label>
                        <textarea id="commit-note-${lineId}" placeholder="e.g., Happy to lead the API integration work" maxlength="200"></textarea>
                        <p class="helper-text">Max 200 characters</p>
                    </div>
                    
                    <!-- Need Info response detail -->
                    <div class="response-detail" id="needInfo-${lineId}">
                        <label>Your question: <span class="required">*</span></label>
                        <textarea id="needinfo-question-${lineId}" placeholder="What specific information do you need?" maxlength="500" required></textarea>
                        <p class="helper-text">Max 500 characters</p>
                        <p class="required-field" id="needinfo-error-${lineId}" style="display: none;">Please enter your question</p>
                    </div>
                    
                    <!-- Can't Commit response detail -->
                    <div class="response-detail" id="cantCommit-${lineId}">
                        <label>Explain your blocker: <span class="required">*</span></label>
                        <textarea id="cantcommit-reason-${lineId}" placeholder="What's preventing you from committing to this?" maxlength="500" required></textarea>
                        <p class="helper-text">Max 500 characters</p>
                        <p class="required-field" id="cantcommit-error-${lineId}" style="display: none;">Please explain your blocker</p>
                    </div>
                    
                    ${line.responses && Object.keys(line.responses).length > 0 ? `
                    <div class="responders-list">
                        ${Object.keys(line.responses).map(userId => {
                            const teammate = session.teammates[userId];
                            return teammate ? `<div class="responder-icon" title="${teammate.name}">${teammate.icon}</div>` : '';
                        }).join('')}
                    </div>` : ''}
                `;
                
                container.appendChild(lineDiv);
            });
            
            showScreen('reviewScreen');
        }

        // Select response type for a line - GLOBAL
        window.selectResponse = function(lineId, responseType) {
            const lineDiv = document.querySelector(`[data-line-id="${lineId}"]`);
            
            // Deselect all buttons for this line
            lineDiv.querySelectorAll('.response-btn').forEach(btn => btn.classList.remove('selected'));
            
            // Hide all response details for this line
            lineDiv.querySelectorAll('.response-detail').forEach(detail => detail.classList.remove('active'));
            
            // Select the clicked button
            const selectedBtn = lineDiv.querySelector(`.${responseType}-btn`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // Show the corresponding detail section
            const detailSection = document.getElementById(`${responseType}-${lineId}`);
            if (detailSection) {
                detailSection.classList.add('active');
            }
            
            // Store the selection
            lineDiv.setAttribute('data-selected-response', responseType);
        }

        // Submit all responses - GLOBAL
        window.submitAllResponses = async function() {
            const sessionId = sessionStorage.getItem('currentSessionId');
            const teammateId = sessionStorage.getItem('currentTeammateId');
            const session = JSON.parse(sessionStorage.getItem('currentSession'));
            
            const lines = session.lines || {};
            const lineIds = Object.keys(lines);
            const responses = {};
            let validationErrors = [];
            
            // Validate and collect all responses
            lineIds.forEach(lineId => {
                const lineDiv = document.querySelector(`[data-line-id="${lineId}"]`);
                const responseType = lineDiv.getAttribute('data-selected-response');
                
                if (!responseType) {
                    validationErrors.push(`Please select a response for: ${lines[lineId].text.substring(0, 50)}...`);
                    return;
                }
                
                const response = {
                    type: responseType,
                    timestamp: Date.now()
                };
                
                // Collect response details based on type
                if (responseType === 'commit') {
                    const note = document.getElementById(`commit-note-${lineId}`).value.trim();
                    if (note) {
                        response.note = note;
                    }
                } else if (responseType === 'needInfo') {
                    const question = document.getElementById(`needinfo-question-${lineId}`).value.trim();
                    if (!question) {
                        validationErrors.push(`Please enter your question for: ${lines[lineId].text.substring(0, 50)}...`);
                        document.getElementById(`needinfo-error-${lineId}`).style.display = 'block';
                        return;
                    }
                    response.question = question;
                } else if (responseType === 'cantCommit') {
                    const reason = document.getElementById(`cantcommit-reason-${lineId}`).value.trim();
                    if (!reason) {
                        validationErrors.push(`Please explain your blocker for: ${lines[lineId].text.substring(0, 50)}...`);
                        document.getElementById(`cantcommit-error-${lineId}`).style.display = 'block';
                        return;
                    }
                    response.reason = reason;
                }
                
                responses[lineId] = response;
            });
            
            // Show validation errors if any
            if (validationErrors.length > 0) {
                alert('Please complete the following:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            try {
                // Submit all responses to Firebase
                for (const lineId of lineIds) {
                    await database.ref(`sessions/${sessionId}/lines/${lineId}/responses/${teammateId}`).set(responses[lineId]);
                }
                
                // Show confirmation screen
                showConfirmation(session, responses);
                
            } catch (error) {
                console.error('Error submitting responses:', error);
                alert('Error submitting responses. Please try again.');
            }
        }

        // Load Dashboard - GLOBAL
        window.loadDashboard = async function() {
            const sessionId = sessionStorage.getItem('currentSessionId');
            if (!sessionId) {
                alert('No session selected');
                return;
            }

            try {
                // Set up real-time listener for session updates
                database.ref(`sessions/${sessionId}`).on('value', (snapshot) => {
                    const session = snapshot.val();
                    if (session) {
                        displayDashboard(session, sessionId);
                    }
                });
                
                showScreen('dashboardScreen');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard. Please try again.');
            }
        }

        // Display Dashboard - GLOBAL
        window.displayDashboard = function(session, sessionId) {
            // Update header info
            document.getElementById('dashboardSessionName').textContent = session.name;
            document.getElementById('dashboardSessionCode').textContent = session.code;
            
            // Display context if provided
            const contextDiv = document.getElementById('dashboardContext');
            const contextText = document.getElementById('dashboardContextText');
            if (session.context && session.context.trim()) {
                contextText.textContent = session.context;
                contextDiv.style.display = 'block';
            } else {
                contextDiv.style.display = 'none';
            }
            
            const lines = session.lines || {};
            const teammates = session.teammates || {};
            const lineCount = Object.keys(lines).length;
            const teammateCount = Object.keys(teammates).length;
            
            document.getElementById('dashboardSessionInfo').textContent = 
                `${lineCount} commitment${lineCount !== 1 ? 's' : ''} | ${teammateCount} teammate${teammateCount !== 1 ? 's' : ''}`;
            
            // Calculate overall progress
            let totalResponses = 0;
            let totalRequired = lineCount * teammateCount;
            
            Object.values(lines).forEach(line => {
                if (line.responses) {
                    totalResponses += Object.keys(line.responses).length;
                }
            });
            
            const progressPercent = totalRequired > 0 ? Math.round((totalResponses / totalRequired) * 100) : 0;
            document.getElementById('dashboardProgressFill').style.width = progressPercent + '%';
            
            // Display lines
            displayDashboardLines(session);
            
            // Display teammates
            displayDashboardTeammates(session);
        }

        // Display Dashboard Lines - GLOBAL
        window.displayDashboardLines = function(session) {
            const container = document.getElementById('dashboardLinesContainer');
            container.innerHTML = '';
            
            const lines = session.lines || {};
            const teammates = session.teammates || {};
            const lineIds = Object.keys(lines).sort((a, b) => lines[a].order - lines[b].order);
            const teammateCount = Object.keys(teammates).length;
            
            lineIds.forEach(lineId => {
                const line = lines[lineId];
                const responses = line.responses || {};
                const responseCount = Object.keys(responses).length;
                
                let status = 'none';
                let needsAttention = false;
                
                if (responseCount === teammateCount && teammateCount > 0) {
                    status = 'complete';
                } else if (responseCount > 0) {
                    status = 'partial';
                }
                
                // Check for questions or blockers
                Object.values(responses).forEach(r => {
                    if (r.type === 'needInfo' || r.type === 'cantCommit') {
                        needsAttention = true;
                    }
                });
                
                const lineDiv = document.createElement('div');
                lineDiv.className = 'dashboard-line-item';
                if (status === 'complete') lineDiv.classList.add('complete');
                if (needsAttention) lineDiv.classList.add('needs-attention');
                
                let html = `
                    <div class="dashboard-line-header">
                        <h4>${line.text}</h4>
                        <span class="response-status ${status}">
                            ${responseCount}/${teammateCount} ${status === 'complete' ? '‚úì' : ''}
                        </span>
                    </div>
                `;
                
                if (responseCount > 0) {
                    html += '<div class="dashboard-responses">';
                    
                    Object.keys(responses).forEach(userId => {
                        const response = responses[userId];
                        const teammate = teammates[userId];
                        
                        if (!teammate) return;
                        
                        html += `
                            <div class="dashboard-response-item ${response.type}">
                                <div class="dashboard-response-icon">${teammate.icon}</div>
                                <div class="dashboard-response-content">
                                    <div class="name">${teammate.name}${teammate.role ? ` (${teammate.role})` : ''}</div>
                        `;
                        
                        if (response.type === 'commit') {
                            html += `<span style="color: #5B7553; font-weight: 600;">${session.buttonLabels.commit}</span>`;
                            if (response.note) {
                                html += `<div class="note">"${response.note}"</div>`;
                            }
                        } else if (response.type === 'needInfo') {
                            html += `<span style="color: #2B7A78; font-weight: 600;">${session.buttonLabels.needInfo}</span>`;
                            if (response.question) {
                                html += `<div class="question">"${response.question}"</div>`;
                            }
                        } else if (response.type === 'cantCommit') {
                            html += `<span style="color: #E97451; font-weight: 600;">${session.buttonLabels.cantCommit}</span>`;
                            if (response.reason) {
                                html += `<div class="blocker">"${response.reason}"</div>`;
                            }
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<p style="color: #718096; font-size: 14px; margin-top: 8px;">‚è≥ Waiting for responses...</p>';
                }
                
                lineDiv.innerHTML = html;
                container.appendChild(lineDiv);
            });
        }

        // Display Dashboard Teammates - GLOBAL
        window.displayDashboardTeammates = function(session) {
            const container = document.getElementById('dashboardTeammatesContainer');
            container.innerHTML = '';
            
            const teammates = session.teammates || {};
            const lines = session.lines || {};
            const lineCount = Object.keys(lines).length;
            
            // Calculate completion for each teammate
            const teammateStats = [];
            
            Object.keys(teammates).forEach(userId => {
                const teammate = teammates[userId];
                let responseCount = 0;
                
                Object.values(lines).forEach(line => {
                    if (line.responses && line.responses[userId]) {
                        responseCount++;
                    }
                });
                
                const percentage = lineCount > 0 ? Math.round((responseCount / lineCount) * 100) : 0;
                
                teammateStats.push({
                    id: userId,
                    teammate: teammate,
                    responseCount: responseCount,
                    percentage: percentage
                });
            });
            
            // Sort by completion percentage (descending)
            teammateStats.sort((a, b) => b.percentage - a.percentage);
            
            teammateStats.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'dashboard-teammate-item';
                if (stat.percentage === 100) {
                    div.classList.add('complete');
                } else if (stat.percentage > 0) {
                    div.classList.add('partial');
                }
                
                div.innerHTML = `
                    <div class="dashboard-teammate-icon">${stat.teammate.icon}</div>
                    <div class="dashboard-teammate-info">
                        <div class="name">${stat.teammate.name}</div>
                        ${stat.teammate.role ? `<div class="role">${stat.teammate.role}</div>` : ''}
                    </div>
                    <div class="dashboard-teammate-progress">
                        <div class="percentage">${stat.responseCount}/${lineCount}</div>
                        <div class="label">${stat.percentage === 100 ? '‚úì Complete' : stat.percentage > 0 ? '‚è≥ In Progress' : '‚è≥ Pending'}</div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // Refresh Dashboard - GLOBAL
        window.refreshDashboard = function() {
            loadDashboard();
        }

        // Update goToDashboard to use new loader - GLOBAL
        window.goToDashboard = function() {
            loadDashboard();
        }

        // Export Session - GLOBAL
        window.exportSession = async function() {
            const sessionId = sessionStorage.getItem('currentSessionId');
            if (!sessionId) {
                alert('No session selected');
                return;
            }

            try {
                const snapshot = await database.ref(`sessions/${sessionId}`).once('value');
                const session = snapshot.val();
                
                if (!session) {
                    alert('Session not found');
                    return;
                }
                
                const markdown = generateMarkdownExport(session);
                document.getElementById('exportPreview').textContent = markdown;
                document.getElementById('exportModal').classList.add('active');
                
                // Store for download
                sessionStorage.setItem('exportMarkdown', markdown);
                sessionStorage.setItem('exportFilename', `${session.code}_summary.md`);
                
            } catch (error) {
                console.error('Error exporting session:', error);
                alert('Error exporting session. Please try again.');
            }
        }

        // Generate Markdown Export - GLOBAL
        window.generateMarkdownExport = function(session) {
            const lines = session.lines || {};
            const teammates = session.teammates || {};
            const lineIds = Object.keys(lines).sort((a, b) => lines[a].order - lines[b].order);
            
            // Calculate stats
            const totalLines = lineIds.length;
            const totalTeammates = Object.keys(teammates).length;
            let totalResponses = 0;
            Object.values(lines).forEach(line => {
                if (line.responses) {
                    totalResponses += Object.keys(line.responses).length;
                }
            });
            const responseRate = totalLines * totalTeammates > 0 ? 
                Math.round((totalResponses / (totalLines * totalTeammates)) * 100) : 0;
            
            // Build markdown
            let md = `# ${session.name} - Sign-Off Summary\n\n`;
            md += `**Session:** ${session.code}  \n`;
            md += `**Created by:** ${session.createdBy}  \n`;
            md += `**Date:** ${new Date(session.createdAt).toLocaleDateString()}  \n`;
            md += `**Status:** ${responseRate === 100 ? '‚úÖ Complete' : '‚è≥ In Progress'} (${totalResponses}/${totalLines * totalTeammates} responded)  \n\n`;
            
            if (session.context) {
                md += `**Context:** ${session.context}\n\n`;
            }
            
            if (session.deadline) {
                md += `**Deadline:** ${new Date(session.deadline).toLocaleDateString()}\n\n`;
            }
            
            md += `---\n\n`;
            md += `## Commitments\n\n`;
            
            // Export each line with responses
            lineIds.forEach((lineId, index) => {
                const line = lines[lineId];
                const responses = line.responses || {};
                const responseCount = Object.keys(responses).length;
                
                // Line header with status
                const statusIcon = responseCount === totalTeammates ? '‚úÖ' : responseCount > 0 ? '‚è≥' : '‚≠ï';
                md += `### ${statusIcon} ${line.text}\n\n`;
                
                if (responseCount === 0) {
                    md += `*No responses yet*\n\n`;
                } else {
                    md += `**Team Response:**\n`;
                    
                    // Group responses by type
                    const committed = [];
                    const needInfo = [];
                    const cantCommit = [];
                    
                    Object.keys(responses).forEach(userId => {
                        const response = responses[userId];
                        const teammate = teammates[userId];
                        if (!teammate) return;
                        
                        const timestamp = new Date(response.timestamp).toLocaleString();
                        const entry = { teammate, response, timestamp };
                        
                        if (response.type === 'commit') committed.push(entry);
                        else if (response.type === 'needInfo') needInfo.push(entry);
                        else if (response.type === 'cantCommit') cantCommit.push(entry);
                    });
                    
                    // Export committed responses
                    if (committed.length > 0) {
                        committed.forEach(({ teammate, response, timestamp }) => {
                            md += `- ${teammate.icon} **${teammate.name}:** "${session.buttonLabels.commit}" √¢≈ì" *(${timestamp})*\n`;
                            if (response.note) {
                                md += `  _"${response.note}"_\n`;
                            }
                        });
                        md += `\n`;
                    }
                    
                    // Export questions/discussions
                    if (needInfo.length > 0) {
                        md += `**Discussion:**\n`;
                        needInfo.forEach(({ teammate, response, timestamp }) => {
                            md += `- ${teammate.icon} **${teammate.name}:** ${session.buttonLabels.needInfo} *(${timestamp})*\n`;
                            md += `  > "${response.question}"\n`;
                        });
                        md += `\n`;
                    }
                    
                    // Export blockers
                    if (cantCommit.length > 0) {
                        md += `**Blockers:**\n`;
                        cantCommit.forEach(({ teammate, response, timestamp }) => {
                            md += `- ${teammate.icon} **${teammate.name}:** ${session.buttonLabels.cantCommit} *(${timestamp})*\n`;
                            md += `  > "${response.reason}"\n`;
                        });
                        md += `\n`;
                    }
                }
                
                md += `---\n\n`;
            });
            
            // Response Record table
            md += `## Response Record\n\n`;
            md += `| Teammate | Role | Responded | Status |\n`;
            md += `|----------|------|-----------|--------|\n`;
            
            Object.keys(teammates).forEach(userId => {
                const teammate = teammates[userId];
                let responseCount = 0;
                
                Object.values(lines).forEach(line => {
                    if (line.responses && line.responses[userId]) {
                        responseCount++;
                    }
                });
                
                const percentage = totalLines > 0 ? Math.round((responseCount / totalLines) * 100) : 0;
                const status = percentage === 100 ? '‚úÖ Complete' : percentage > 0 ? '‚è≥ In Progress' : '‚≠ï Pending';
                
                md += `| ${teammate.icon} ${teammate.name} | ${teammate.role || 'N/A'} | ${responseCount}/${totalLines} | ${status} |\n`;
            });
            
            md += `\n---\n\n`;
            md += `*Created with Co-Sign | https://maurakrandall.github.io/co-sign.html*\n`;
            
            return md;
        }

        // Close Export Modal - GLOBAL
        window.closeExportModal = function() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // Copy Export to Clipboard - GLOBAL
        window.copyExportToClipboard = function() {
            const markdown = sessionStorage.getItem('exportMarkdown');
            if (!markdown) {
                alert('No export available');
                return;
            }
            
            navigator.clipboard.writeText(markdown).then(() => {
                alert('Exported summary copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Please try the download option.');
            });
        }

        // Download Export as .md file - GLOBAL
        window.downloadExport = function() {
            const markdown = sessionStorage.getItem('exportMarkdown');
            const filename = sessionStorage.getItem('exportFilename') || 'co-sign_summary.md';
            
            if (!markdown) {
                alert('No export available');
                return;
            }
            
            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Export downloaded!');
        }

        // Show confirmation screen - GLOBAL
        window.showConfirmation = function(session, responses) {
            const name = sessionStorage.getItem('currentTeammateName');
            const icon = sessionStorage.getItem('currentTeammateIcon');
            
            const summaryDiv = document.getElementById('confirmationSummary');
            
            let html = `<h3 style="color: #0B2A2F; margin-bottom: 16px;">${icon} ${name}'s Responses</h3>`;
            
            let commitCount = 0;
            let needInfoCount = 0;
            let cantCommitCount = 0;
            
            Object.keys(responses).forEach(lineId => {
                const line = session.lines[lineId];
                const response = responses[lineId];
                
                if (response.type === 'commit') commitCount++;
                else if (response.type === 'needInfo') needInfoCount++;
                else if (response.type === 'cantCommit') cantCommitCount++;
            });
            
            html += `<p style="color: #718096; margin-bottom: 16px;">`;
            if (commitCount > 0) html += `‚úì ${commitCount} committed | `;
            if (needInfoCount > 0) html += `? ${needInfoCount} need info | `;
            if (cantCommitCount > 0) html += `√¢≈°¬† ${cantCommitCount} can't commit`;
            html += `</p>`;
            
            summaryDiv.innerHTML = html;
            showScreen('confirmationScreen');
        }

        // Context Card Import Functions
        window.showImportModal = function() {
            const modal = document.getElementById('import-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        window.hideImportModal = function() {
            const modal = document.getElementById('import-modal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('context-card-paste').value = '';
            }
        }

        window.handleContextCardFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    processContextCardImport(json);
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid Context Card JSON file.');
                }
            };
            reader.readAsText(file);
        }

        window.importFromPaste = function() {
            const jsonText = document.getElementById('context-card-paste').value.trim();
            if (!jsonText) {
                alert('Please paste Context Card JSON first');
                return;
            }

            try {
                const json = JSON.parse(jsonText);
                processContextCardImport(json);
            } catch (error) {
                alert('Invalid JSON. Please check your Context Card format.');
            }
        }

        window.processContextCardImport = function(contextCard) {
            // Validate structure
            if (!contextCard.team || !Array.isArray(contextCard.team)) {
                alert('Invalid Context Card format. Missing team array.');
                return;
            }

            // Clear existing teammates
            const container = document.getElementById('teammatesContainer');
            container.innerHTML = '';
            teammateCounter = 0;

            // Add each team member
            contextCard.team.forEach(member => {
                teammateCounter++;
                const teammateDiv = document.createElement('div');
                teammateDiv.className = 'teammate-item';
                teammateDiv.id = `teammate-${teammateCounter}`;
                
                // Determine icon based on type
                const icon = member.type === 'human' ? 'üë§' : 'ü§ñ';
                
                teammateDiv.innerHTML = `
                    <div class="icon-select" id="teammateIcon-${teammateCounter}" onclick="openIconPicker(${teammateCounter})">
                        ${icon}
                    </div>
                    <div>
                        <label>Name:</label>
                        <input type="text" id="teammateName-${teammateCounter}" value="${member.name || ''}" placeholder="Name" required>
                    </div>
                    <div>
                        <label>Role (optional):</label>
                        <input type="text" id="teammateRole-${teammateCounter}" value="${member.role || ''}" placeholder="Role">
                    </div>
                `;
                container.appendChild(teammateDiv);
            });

            // Hide modal and show success
            hideImportModal();
            alert(`‚úÖ Team imported! ${contextCard.team.length} team members added.`);
            
            // Hide import button since team is already imported
            const importBtn = document.getElementById('importContextCardBtn');
            if (importBtn) {
                importBtn.style.display = 'none';
            }
        }

    </script>

    <!-- Import Modal -->
    <div id="import-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
            <h3 style="margin: 0 0 20px 0; color: #0B2A2F;">üé¥ Import Team Context Card</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0B2A2F;">Upload JSON File</label>
                <input type="file" accept=".json" onchange="handleContextCardFile(event)" style="width: 100%; padding: 10px; border: 2px solid #2B7A78; border-radius: 8px; background: white; color: #3D3D3D;">
            </div>

            <div style="margin: 20px 0; text-align: center; color: #718096;">‚Äî OR ‚Äî</div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0B2A2F;">Paste JSON</label>
                <textarea id="context-card-paste" placeholder='Paste your Context Card JSON here...' style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #2B7A78; border-radius: 8px; font-family: monospace; font-size: 13px; resize: vertical; background: white; color: #3D3D3D;"></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="hideImportModal()" style="padding: 10px 20px; background: #718096; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Cancel</button>
                <button onclick="importFromPaste()" style="padding: 10px 20px; background: #DAA520; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">Import</button>
            </div>
        </div>
    </div>

</body>
</html>
