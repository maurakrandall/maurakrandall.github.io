<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Sign - Lightweight Decision Commitment</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" onload="console.log('Firebase app loaded')"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js" onload="console.log('Firebase database loaded')"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0B2A2F 0%, #0D3B2A 100%);
            min-height: 100vh;
            padding: 20px;
            color: #3D3D3D;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #FFF5E1;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #2B7A78;
        }

        .header h1 {
            font-size: 48px;
            color: #0B2A2F;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .tagline {
            font-size: 18px;
            color: #718096;
            font-weight: 400;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #0B2A2F;
            margin-bottom: 8px;
            font-size: 16px;
        }

        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            background: white;
            color: #3D3D3D;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #DAA520;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .hint {
            font-size: 14px;
            color: #718096;
            margin-top: 6px;
            font-style: italic;
        }

        .btn {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: #DAA520;
            color: #0B2A2F;
        }

        .btn-primary:hover {
            background: #B8860B;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #FFF5E1;
            color: #0B2A2F;
            border: 2px solid #2B7A78;
        }

        .btn-secondary:hover {
            background: #F5E6C8;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .suggestions {
            background: #F0F9F8;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }

        .suggestions-label {
            font-size: 14px;
            color: #0B2A2F;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .suggestions-text {
            font-size: 14px;
            color: #5B7553;
        }

        .line-item {
            background: white;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .line-item input {
            border: 1px solid #E2E8F0;
            margin-bottom: 8px;
        }

        .line-item .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #E97451;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .line-item .remove-btn:hover {
            background: #D65A3A;
        }

        .add-more-btn {
            width: 100%;
            padding: 12px;
            background: #F0F9F8;
            border: 2px dashed #2B7A78;
            border-radius: 6px;
            color: #0B2A2F;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .add-more-btn:hover {
            background: #E0F2F1;
        }

        .teammate-item {
            background: white;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            gap: 12px;
            align-items: start;
        }

        .teammate-item .icon-select {
            font-size: 32px;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            background: white;
        }

        .session-created {
            text-align: center;
        }

        .session-code-display {
            background: white;
            border: 3px solid #DAA520;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
        }

        .session-code-display .code {
            font-size: 32px;
            font-weight: 700;
            color: #0B2A2F;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            margin: 12px 0;
        }

        .session-link {
            background: #F0F9F8;
            border: 2px solid #2B7A78;
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            word-break: break-all;
            font-size: 14px;
            color: #0B2A2F;
        }

        .copy-btn {
            background: #2B7A78;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 6px;
        }

        .copy-btn:hover {
            background: #236663;
        }

        .icon-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .icon-picker-modal.active {
            display: flex;
        }

        .icon-picker-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .icon-option {
            font-size: 32px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            border: 2px solid transparent;
        }

        .icon-option:hover {
            background: #F0F9F8;
            border-color: #2B7A78;
        }

        .footer {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px solid #2B7A78;
            text-align: center;
            color: #718096;
            font-size: 14px;
        }

        .footer strong {
            color: #0B2A2F;
        }

        .footer a {
            color: #2B7A78;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer ul {
            list-style: none;
            margin: 12px 0;
        }

        .footer li {
            margin: 6px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 24px;
            }

            .header h1 {
                font-size: 36px;
            }

            .teammate-item {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Co-Sign</h1>
            <p class="tagline">Lightweight commitment for team decisions</p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <p style="text-align: center; font-size: 18px; color: #718096; margin-bottom: 30px;">
                Get clear sign-off line-by-line, with friendly accountability that actually sticks.
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showScreen('setupScreen')">Create New Session</button>
                <button class="btn btn-secondary" onclick="showScreen('joinScreen')">Join Existing Session</button>
            </div>
        </div>

        <!-- Setup Session Screen -->
        <div id="setupScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Create Session</h2>
            
            <div class="form-group">
                <label>Decision name: *</label>
                <input type="text" id="sessionName" placeholder="e.g., Q1 Product Roadmap" required>
            </div>

            <div class="form-group">
                <label>Context (optional - link or description):</label>
                <textarea id="sessionContext" placeholder="Add a link to your doc or brief description..."></textarea>
            </div>

            <div class="form-group">
                <label>Deadline (optional):</label>
                <input type="date" id="sessionDeadline">
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')">Back</button>
                <button class="btn btn-primary" onclick="showScreen('customizeButtonsScreen')">Continue</button>
            </div>
        </div>

        <!-- Customize Buttons Screen -->
        <div id="customizeButtonsScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Customize Experience</h2>
            
            <div class="form-group">
                <label>When teammates commit, button says: *</label>
                <input type="text" id="commitButtonText" placeholder="I'm in" maxlength="20" required>
                <div class="suggestions">
                    <div class="suggestions-label">üí° Examples:</div>
                    <div class="suggestions-text">I'm in | I agree | Count me in | I commit to this | Let's do it</div>
                </div>
            </div>

            <div class="form-group">
                <label>When teammates need info:</label>
                <select id="needInfoButton">
                    <option value="Need More Info">Need More Info</option>
                    <option value="Open Questions">Open Questions</option>
                    <option value="Let's Discuss">Let's Discuss</option>
                    <option value="Need Clarification">Need Clarification</option>
                    <option value="Want to Talk">Want to Talk</option>
                </select>
            </div>

            <div class="form-group">
                <label>When they can't commit:</label>
                <select id="cantCommitButton">
                    <option value="Can't Commit">Can't Commit</option>
                    <option value="Have Concerns">Have Concerns</option>
                    <option value="Need Changes">Need Changes</option>
                    <option value="Data Request">Data Request</option>
                    <option value="Can't Right Now">Can't Right Now</option>
                    <option value="Need Discussion">Need Discussion</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('setupScreen')">Back</button>
                <button class="btn btn-primary" onclick="showScreen('addLinesScreen')">Continue</button>
            </div>
        </div>

        <!-- Add Lines Screen -->
        <div id="addLinesScreen" class="screen">
            <h2 style="margin-bottom: 16px; color: #0B2A2F;">Commitments to Sign</h2>
            <p style="color: #718096; margin-bottom: 24px; line-height: 1.5;">
                Create a line for each decision you're seeking agreement on. Your teammates will respond to each line individually‚Äîso you'll know exactly what people commit to and where they have questions.
            </p>
            
            <div id="linesContainer">
                <!-- Lines will be added dynamically -->
            </div>

            <button class="add-more-btn" onclick="addLine()">+ Add Another Line</button>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('customizeButtonsScreen')">Back</button>
                <button class="btn btn-primary" onclick="showScreen('addTeammatesScreen')">Continue to Add Teammates</button>
            </div>
        </div>

        <!-- Add Teammates Screen -->
        <div id="addTeammatesScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Add Teammates</h2>
            
            <div id="teammatesContainer">
                <!-- Teammates will be added dynamically -->
            </div>

            <button class="add-more-btn" onclick="addTeammate()">+ Add Teammate</button>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('addLinesScreen')">Back</button>
                <button class="btn btn-primary" onclick="alert('Button clicked!'); createSession();">Create Session</button>
            </div>
        </div>

        <!-- Session Created Screen -->
        <div id="sessionCreatedScreen" class="screen">
            <div class="session-created">
                <h2 style="color: #0B2A2F; margin-bottom: 16px;">‚úÖ Session Created!</h2>
                
                <div id="sessionSummary">
                    <!-- Will be populated dynamically -->
                </div>

                <div class="session-code-display">
                    <div style="font-size: 16px; color: #718096; margin-bottom: 8px;">Session Code:</div>
                    <div class="code" id="displaySessionCode">COSIGN-XXXX</div>
                </div>

                <div>
                    <div style="font-size: 14px; color: #718096; margin-bottom: 8px;">Share link:</div>
                    <div class="session-link" id="displaySessionLink"></div>
                </div>

                <div style="margin: 24px 0;">
                    <button class="copy-btn" onclick="copyCode()">Copy Code</button>
                    <button class="copy-btn" onclick="copyLink()">Copy Link</button>
                </div>

                <button class="btn btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
            </div>
        </div>

        <!-- Join Session Screen -->
        <div id="joinScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Join Session</h2>
            
            <div class="form-group">
                <label>Enter session code:</label>
                <input type="text" id="joinCode" placeholder="COSIGN-XXXX" style="text-transform: uppercase;">
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showScreen('welcomeScreen')">Back</button>
                <button class="btn btn-primary" onclick="joinSession()">Join Session</button>
            </div>
        </div>

        <!-- Dashboard Screen (placeholder) -->
        <div id="dashboardScreen" class="screen">
            <h2 style="margin-bottom: 24px; color: #0B2A2F;">Dashboard</h2>
            <p style="color: #718096;">Dashboard coming in Phase 3...</p>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>Part of the Team Ritual Apps collection</strong></p>
            <p><a href="https://maurakrandall.github.io/">View all tools ‚Üí</a></p>
            
            <p style="margin-top: 20px;"><strong>Built using the "Triad" model:</strong></p>
            <ul>
                <li>üí´ <strong>Maura:</strong> Product vision, UX design</li>
                <li>üéôÔ∏è <strong>CP:</strong> Technical structure, system logic</li>
                <li>üîÆ <strong>Soph:</strong> Content drafting, strategic thinking</li>
            </ul>
            
            <p>Learn more at <a href="https://thehumanailoop.com/">The Human AI Loop</a></p>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div id="iconPickerModal" class="icon-picker-modal">
        <div class="icon-picker-content">
            <h3 style="margin-bottom: 16px; color: #0B2A2F;">Choose Your Icon</h3>
            <div class="icon-grid" id="iconGrid"></div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" onclick="closeIconPicker()">Close</button>
        </div>
    </div>

    <script>
        console.log('Co-Sign script loaded!');
        
        // Global variables and functions need to be available to inline onclick handlers
        let database;
        let currentScreen = 'welcomeScreen';
        let lineCounter = 0;
        let teammateCounter = 0;
        let currentTeammateIndex = null;
        let sessionData = {
            lines: [],
            teammates: []
        };

        // Available Icons
        const availableIcons = ['üí´', '‚ö°', 'üéØ', 'üöÄ', '‚ú®', 'üî•', 'üí°', 'üåü', 'üíº', 'üé®', 'üìä', 'üîß', 'üí™', 'üé≠', 'üåà', '‚≠ê', 'üé™', 'üé¨', 'üì±', 'üíª', 'üéÆ', 'üéµ', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'ü•Å', 'üé§', 'üéß', 'üìª', 'üì∫', 'üì∑', 'üì∏', 'üé•'];

        // Initialize Firebase when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired');
            
            // Check if Firebase is loaded
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded! Trying to reload...');
                alert('Firebase is not loading. Please refresh the page.');
                return;
            }
            
            console.log('Firebase SDK found, initializing...');
            
            // Firebase Configuration - decision-alignment-tool project
            const firebaseConfig = {
                apiKey: "AIzaSyDTEDAjvGZH4-MOlo-xcDBRqcRQRioV-b4",
                authDomain: "decision-alignment-tool.firebaseapp.com",
                databaseURL: "https://decision-alignment-tool-default-rtdb.firebaseio.com",
                projectId: "decision-alignment-tool",
                storageBucket: "decision-alignment-tool.firebasestorage.app",
                messagingSenderId: "911538633564",
                appId: "1:911538633564:web:17808f5cf9aa178eb51f99"
            };

            // Initialize Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('Firebase initialized successfully!');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Firebase failed to initialize: ' + error.message);
            }
            
            console.log('Firebase initialized');

            // Initialize: Add first line and first teammate
            addLine();
            addTeammate();
            
            // Check if URL has session parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sessionCode = urlParams.get('session');
            if (sessionCode) {
                document.getElementById('joinCode').value = sessionCode;
                showScreen('joinScreen');
            }
        });

        // Screen Navigation - MUST be global for onclick handlers
        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
        }

        // Session Code Generation (from AlignFirst pattern) - GLOBAL
        window.generateSessionCode = function() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'COSIGN-';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Check if session code exists - GLOBAL
        window.isCodeUnique = async function(code) {
            const snapshot = await database.ref('sessions').orderByChild('code').equalTo(code).once('value');
            return !snapshot.exists();
        }

        // Generate unique session code - GLOBAL
        window.generateUniqueSessionCode = async function() {
            let code = generateSessionCode();
            let attempts = 0;
            while (!(await isCodeUnique(code)) && attempts < 10) {
                code = generateSessionCode();
                attempts++;
            }
            return code;
        }

        // Add Line - GLOBAL
        window.addLine = function() {
            lineCounter++;
            const container = document.getElementById('linesContainer');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-item';
            lineDiv.id = `line-${lineCounter}`;
            lineDiv.innerHTML = `
                <button class="remove-btn" onclick="removeLine(${lineCounter})">Remove</button>
                <label>Line ${lineCounter}:</label>
                <input type="text" id="lineText-${lineCounter}" placeholder="e.g., Q1 Goal: Launch Dashboard v2 by March 15" required>
            `;
            container.appendChild(lineDiv);
        }

        // Remove Line - GLOBAL
        window.removeLine = function(id) {
            const lineDiv = document.getElementById(`line-${id}`);
            if (lineDiv) {
                lineDiv.remove();
            }
        }

        // Add Teammate - GLOBAL
        window.addTeammate = function() {
            teammateCounter++;
            const container = document.getElementById('teammatesContainer');
            const teammateDiv = document.createElement('div');
            teammateDiv.className = 'teammate-item';
            teammateDiv.id = `teammate-${teammateCounter}`;
            teammateDiv.innerHTML = `
                <div class="icon-select" id="teammateIcon-${teammateCounter}" onclick="openIconPicker(${teammateCounter})">
                    üí´
                </div>
                <div>
                    <label>Name:</label>
                    <input type="text" id="teammateName-${teammateCounter}" placeholder="Name" required>
                </div>
                <div>
                    <label>Role (optional):</label>
                    <input type="text" id="teammateRole-${teammateCounter}" placeholder="Role">
                </div>
            `;
            container.appendChild(teammateDiv);
        }

        // Icon Picker - GLOBAL
        window.openIconPicker = function(index) {
            currentTeammateIndex = index;
            const modal = document.getElementById('iconPickerModal');
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = '';
            
            availableIcons.forEach(icon => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'icon-option';
                iconDiv.textContent = icon;
                iconDiv.onclick = () => selectIcon(icon);
                grid.appendChild(iconDiv);
            });
            
            modal.classList.add('active');
        }

        window.selectIcon = function(icon) {
            if (currentTeammateIndex !== null) {
                document.getElementById(`teammateIcon-${currentTeammateIndex}`).textContent = icon;
            }
            closeIconPicker();
        }

        window.closeIconPicker = function() {
            document.getElementById('iconPickerModal').classList.remove('active');
            currentTeammateIndex = null;
        }

        // Create Session - GLOBAL
        window.createSession = async function() {
            console.log('Creating session...');
            
            // Validate inputs
            const sessionName = document.getElementById('sessionName').value.trim();
            console.log('Session name:', sessionName);
            if (!sessionName) {
                alert('Please enter a decision name');
                showScreen('setupScreen');
                return;
            }

            const commitButtonText = document.getElementById('commitButtonText').value.trim() || "I'm in";
            console.log('Commit button text:', commitButtonText);
            if (commitButtonText.length < 2 || commitButtonText.length > 20) {
                alert('Commit button text must be 2-20 characters');
                showScreen('customizeButtonsScreen');
                return;
            }

            // Collect lines - check ALL line elements that exist in the DOM
            const lines = {};
            let lineOrder = 1;
            const lineElements = document.querySelectorAll('[id^="lineText-"]');
            console.log('Found line elements:', lineElements.length);
            
            lineElements.forEach((element) => {
                const lineText = element.value.trim();
                if (lineText) {
                    const lineId = `line-${Date.now()}-${lineOrder}`;
                    lines[lineId] = {
                        text: lineText,
                        order: lineOrder++,
                        requiredSigners: "all",
                        responses: {}
                    };
                }
            });

            console.log('Collected lines:', Object.keys(lines).length);
            if (Object.keys(lines).length === 0) {
                alert('Please add at least one commitment line');
                showScreen('addLinesScreen');
                return;
            }

            // Collect teammates - check ALL teammate elements that exist in the DOM
            const teammates = {};
            const teammateNameElements = document.querySelectorAll('[id^="teammateName-"]');
            console.log('Found teammate elements:', teammateNameElements.length);
            
            teammateNameElements.forEach((element, index) => {
                const name = element.value.trim();
                if (name) {
                    const id = element.id.split('-')[1];
                    const icon = document.getElementById(`teammateIcon-${id}`)?.textContent || 'üí´';
                    const role = document.getElementById(`teammateRole-${id}`)?.value.trim() || '';
                    
                    const userId = `user-${Date.now()}-${index}`;
                    teammates[userId] = {
                        name: name,
                        icon: icon,
                        role: role,
                        joinedAt: Date.now()
                    };
                }
            });

            console.log('Collected teammates:', Object.keys(teammates).length);
            if (Object.keys(teammates).length === 0) {
                alert('Please add at least one teammate');
                showScreen('addTeammatesScreen');
                return;
            }

            // Generate unique session code
            const sessionCode = await generateUniqueSessionCode();
            const sessionId = database.ref('sessions').push().key;

            // Get other form data
            const context = document.getElementById('sessionContext').value.trim();
            const deadline = document.getElementById('sessionDeadline').value;
            const needInfoButton = document.getElementById('needInfoButton').value;
            const cantCommitButton = document.getElementById('cantCommitButton').value;

            // Build session object
            const session = {
                code: sessionCode,
                name: sessionName,
                context: context,
                createdBy: Object.values(teammates)[0]?.name || "Facilitator",
                createdAt: Date.now(),
                deadline: deadline ? new Date(deadline).getTime() : null,
                status: "open",
                buttonLabels: {
                    commit: commitButtonText,
                    needInfo: needInfoButton,
                    cantCommit: cantCommitButton
                },
                lines: lines,
                teammates: teammates
            };

            // Save to Firebase
            try {
                await database.ref(`sessions/${sessionId}`).set(session);
                
                // Store session ID for dashboard
                sessionStorage.setItem('currentSessionId', sessionId);
                sessionStorage.setItem('currentSessionCode', sessionCode);
                
                // Display session created screen
                displaySessionCreated(sessionCode, sessionName, Object.keys(lines).length, Object.keys(teammates).length);
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Error creating session. Please try again.');
            }
        }

        // Display Session Created - GLOBAL
        window.displaySessionCreated = function(code, name, lineCount, teammateCount) {
            document.getElementById('displaySessionCode').textContent = code;
            
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?session=${code}`;
            document.getElementById('displaySessionLink').textContent = link;
            
            document.getElementById('sessionSummary').innerHTML = `
                <h3 style="color: #0B2A2F; margin-bottom: 8px;">${name}</h3>
                <p style="color: #718096;">${lineCount} commitments | ${teammateCount} teammates</p>
            `;
            
            showScreen('sessionCreatedScreen');
        }

        // Copy Functions - GLOBAL
        window.copyCode = function() {
            const code = document.getElementById('displaySessionCode').textContent;
            navigator.clipboard.writeText(code);
            alert('Session code copied!');
        }

        window.copyLink = function() {
            const link = document.getElementById('displaySessionLink').textContent;
            navigator.clipboard.writeText(link);
            alert('Link copied!');
        }

        // Go to Dashboard - GLOBAL
        window.goToDashboard = function() {
            showScreen('dashboardScreen');
        }

        // Join Session - GLOBAL
        window.joinSession = async function() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!code) {
                alert('Please enter a session code');
                return;
            }

            try {
                const snapshot = await database.ref('sessions').orderByChild('code').equalTo(code).once('value');
                if (snapshot.exists()) {
                    const sessionId = Object.keys(snapshot.val())[0];
                    sessionStorage.setItem('currentSessionId', sessionId);
                    sessionStorage.setItem('currentSessionCode', code);
                    alert('Session found! Join flow coming in Phase 2...');
                } else {
                    alert('Session not found. Please check the code and try again.');
                }
            } catch (error) {
                console.error('Error joining session:', error);
                alert('Error joining session. Please try again.');
            }
        }

    </script>
</body>
</html>
